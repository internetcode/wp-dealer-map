var map,infoPopup,geocoder,find_directions,directS,directD,to_marker,$j=jQuery.noConflict(),markersArray=[],markersCoords=[],addresses=[],popups=[],mainIcon=dealer_map.mainIcon,youIcon=dealer_map.youIcon,myshadow=dealer_map.myshadow,map_type=dealer_map.map_type,zoomer=parseInt(dealer_map.map_zoom),marker_event=dealer_map.marker_event,drop_bounce=dealer_map.drop_b,gDirect=dealer_map.get_direct,noStores=dealer_map.nostores,yourPosition=dealer_map.yourlocation,error_noS=dealer_map.error_nos,error_noD=dealer_map.error_nod,error_aD=dealer_map.address_err,error_oP=dealer_map.error_onpage,num_of_Col=dealer_map.colnum,ajax_error=dealer_map.aj_error;function inite(){directS=new google.maps.DirectionsService,directD=new google.maps.DirectionsRenderer,geocoder=new google.maps.Geocoder,infoPopup=new google.maps.InfoWindow({content:"",maxWidth:330});var e={zoom:zoomer,center:new google.maps.LatLng(dealer_map.start_lat,dealer_map.start_lng),mapTypeId:map_type};map=new google.maps.Map(document.getElementById("store_map"),e),end_directions(),add_markers(),$j("select[id^=custom_field_]").change(codeAddress),$j("input[id^=search_filter_]").change(codeAddress),$j("#address_search").keypress(function(e){13==e.which&&codeAddress()}),fixURLS()}function find_new_stores(e){get_new_stores(map.getCenter().lat(),map.getCenter().lng(),e)}function add_markers(){end_directions(),clearMarkers(),markersArray.length=0;var e=new google.maps.LatLngBounds;drop_markers(e),markersArray.length>0&&addresses.length>0&&map.fitBounds(e)}function drop_markers(e){for(i=0;i<markersCoords.length;i++){var r="drop"===drop_bounce?google.maps.Animation.DROP:google.maps.Animation.BOUNCE,s=mainIcon,o=!1;0==markersCoords[i].id?(s=youIcon,o=!0):"pro"===markersCoords[i].marker_pro&&(s=dealer_map.proIcon);var a=new google.maps.LatLng(markersCoords[i].lat,markersCoords[i].lng),t=new google.maps.Marker({position:a,map:map,draggable:o,animation:r,id:markersCoords[i].id,store_address:markersCoords[i].address,icon:s,shadow:myshadow});e.extend(t.getPosition()),0==markersCoords[i].id&&google.maps.event.addListener(t,"dragend",function(e){map.setCenter(e.latLng),find_new_stores(1)}),google.maps.event.addListener(t,marker_event,function(e){info_popups(this.id)}),markersArray.push(t)}}function clearMarkers(){for(i=0;i<markersArray.length;i++)google.maps.event.clearListeners(markersArray[i],marker_event),markersArray[i].setMap(null)}function get_new_stores(e,r,s){var o=$j("select[id^=custom_field_]"),a="";for(i=0;i<o.length;i++){var t=o[i],d=$j(t).children("option:selected").text();d&&(a=a+"&"+encodeURIComponent(t.id)+"="+encodeURIComponent(d))}o=$j("input[id^=search_filter_]:checked");var n="",l=$j("#limit").val(),m=$j("#within_distance").val();for(i=0;i<o.length;i++){t=o[i];n=n+"&"+encodeURIComponent(t.id)+"=1"}$j.ajax({type:"GET",url:dealer_map.ajaxurl,data:{action:"dealer_search",security:dealer_map.dealer_mapnonce,lat:e,lng:r,radius:m,limit:l},success:function(e){set_stores(e,!1)},error:function(e){alert(ajax_error)}})}function set_stores(e,r){if(find_directions=!1,popups=e.popup,markersCoords.length=0,addresses.length=0,null===e.stores||void 0===e.stores)return r?error_nostores("case2"):($j("#store_finded h3").remove(),$j("#addresses_list ul").remove(),$j("#addresses_list").html('<ul><li class="'+num_of_Col+" no_stores_found\"><div class='no_stores_found'>"+noStores+"</div></li></ul>"),$j("addresses_list ul").slideDown(),error_nostores("case1"));for(clear_Errmsg(),e.you&&(markersCoords.push({lat:e.you.lat,lng:e.you.lng,id:0,address:"",marker_pro:""}),find_directions=!0),i=0;i<e.stores.length;i++)markersCoords.push({lat:e.stores[i].lat,lng:e.stores[i].lng,id:e.stores[i].store_id,address:e.stores[i].summary,marker_pro:e.stores[i].pin_icon,proseries:e.stores[i].pro}),addresses.push({id:e.stores[i].store_id,address:e.stores[i].summary,distance:e.stores[i].distance,website:e.stores[i].website,marker_pro:e.stores[i].pin_icon});$j(".addresses ul").slideUp(show_addresses(r)),add_markers()}function storefindh3(e,r){var s,o=$j("#store_finded"),a=r?dealer_map.defrange:$j("#within_distance").val(),i=r?dealer_map.defadress:$j("#address_search").val();s="<h3>"+e+" "+dealer_map.found+" "+a+" "+dealer_map.units+" "+dealer_map.from+" "+i+"</h3>",0!==o.length?($j("#store_finded h3").remove(),o.append(s)):o.append(s)}function show_addresses(e){var r="",s="";for(i=0;i<addresses.length;i++){var o,a="";find_directions&&(s="<div class='directions'><a href='#' onclick='calcRoute("+addresses[i].id+");return false;'>"+gDirect+"</a></div>"),o="<div class='store_website'><a href='"+addresses[i].website+"' target='_blank'>"+addresses[i].website+"</a></div>","main"!=addresses[i].marker_pro&&(a=" style='background-image:url(\""+dealer_map.proSerie+"\")' "),r=r+'<li class="'+num_of_Col+'"  '+a+" onmouseover='hoverStart("+addresses[i].id+")' onmouseout='hoverStop("+addresses[i].id+")'><div class='distance'>"+addresses[i].distance+"</div><a href='#' onclick='info_popups("+addresses[i].id+"); return false;'>"+addresses[i].address+"</a>"+o+s+"</li>"}0==addresses.length?r='<li class="'+num_of_Col+"\"><div class='no_stores_found'>"+noStores+"</div></li>":storefindh3(addresses.length,e),$j(".addresses ul").html(r),$j(".addresses ul").slideDown(),fixURLS()}function info_popups(e){var r,s="";for(find_directions&&(s="<div class='directions'><a href='#' onclick='calcRoute("+e+");return false;'>"+gDirect+"</a></div>"),i=0;i<markersArray.length;i++)markersArray[i].id==e&&e>0?(r=markersArray[i],map.panTo(r.getPosition()),null!=popups[e]&&(infoPopup.close(),infoPopup.setContent("<div class='gm_popup'>"+popups[e].join("")+s+"</div>"),infoPopup.open(map,r))):markersArray[i].id==e&&0==e&&(r=markersArray[i],map.panTo(r.getPosition()),infoPopup.close(),infoPopup.setContent("<div class='gm_popup'>"+yourPosition+"</div>"),infoPopup.open(map,r))}function codeAddress(){var e=$j("#address_search").val();if(!e||""===e)return!1;geocoder.geocode({address:e},function(e,r){r==google.maps.GeocoderStatus.OK?(map.setCenter(e[0].geometry.location),find_new_stores(1)):error_nostores("ge_add")})}function codeDefAddress(e,r,s){var o=dealer_map.defadress;"1"===e&&geocoder.geocode({address:o},function(o,a){if(a==google.maps.GeocoderStatus.OK){map.setCenter(o[0].geometry.location);var i=map.getCenter().lat(),t=map.getCenter().lng();$j.ajax({type:"GET",url:dealer_map.ajaxurl,data:{action:"dealer_search",security:dealer_map.dealer_mapnonce,lat:i,lng:t,radius:r,limit:s},success:function(r){set_stores(r,e)},error:function(e){alert(ajax_error)}})}else alert(error_oP)})}function calcRoute(e){var r=!1,s=!1;for(i=0;i<markersArray.length;i++)markersArray[i].id==e?s=markersArray[i]:0==markersArray[i].id&&(r=markersArray[i]);if(r&&s){to_marker=s;var o={origin:r.getPosition(),destination:s.getPosition(),travelMode:google.maps.TravelMode.DRIVING,unitSystem:google.maps.UnitSystem.IMPERIAL};directS.route(o,function(e,r){if(r==google.maps.DirectionsStatus.OK){directD.setMap(map),directD.setDirections(e),$j("#direction_destination").html(to_marker.store_address),$j("#directions_steps").html("");var s=1;if(e.routes.length>0){var o,a,t=e.routes[0];for(o=0;o<t.legs.length;o++){var d=t.legs[o];for(a=0;a<d.steps.length;a++){var n=d.steps[a];$j("#directions_steps").append("<div class='directions_step'><div class='directions_step_id'>"+s+".</div><div class='directions_instructions'>"+n.instructions+"</div><div class='directions_step_distance'>"+n.distance.text+"</div><div style='clear:both; height:0px'></div></div>"),s++}}}for($j("#addresses_list").slideUp(function(){$j("#directions_text").slideDown()}),i=0;i<markersArray.length;i++)markersArray[i].setMap(null);infoPopup.setMap(null)}})}}function error_nostores(e){var r="";switch(e){case"case1":r=error_noS;break;case"case2":r=error_noD;break;case"ge_add":r=error_aD}$j("#dealer-map-error").text(r).show("slow")}function clear_Errmsg(){""!=$j("#dealer-map-error").text()&&$j("#dealer-map-error").text("").hide()}function end_directions(){for(directD.setMap(null),i=0;i<markersArray.length;i++)markersArray[i].setMap(map);$j("#directions_text:visible").slideUp(function(){$j("#addresses_list:hidden").slideDown()})}function hoverStart(e){for(i=0;i<markersArray.length;i++)markersArray[i].id==e&&(marker=markersArray[i],marker.setAnimation(google.maps.Animation.BOUNCE))}function hoverStop(e){for(i=0;i<markersArray.length;i++)markersArray[i].id==e&&(marker=markersArray[i],marker.setAnimation(null))}function fixURLS(){var e=$j(".addresses .store_website a");for(i=0;i<e.length;i++)$j(e[i]).text($j(e[i]).text().replace("http://www.",""))}$j(document).ready(inite),$j(window).load(function(){"1"===dealer_map.showdef&&codeDefAddress(dealer_map.showdef,dealer_map.defrange,dealer_map.deflimit)});